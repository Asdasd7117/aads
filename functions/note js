const axios = require('axios');

exports.handler = async function(event, context) {
  const API_KEY = process.env.API_KEY || 'YOUR_API_KEY'; // استخدم النسخة الاحتياطية للاختبار
  console.log('API_KEY loaded:', API_KEY ? 'Found' : 'Not found');
  const TARGET_URL = 'https://btc240.netlify.app/';
  const waitTime = Math.floor(Math.random() * 21) + 20;

  const jsScenario = {
    instructions: [
      { wait: 10 },
      { wait: waitTime },
      { scroll_y: 500 },
      { scroll_y: 1000 },
      { wait: 5 }
    ]
  };

  const params = {
    api_key: API_KEY,
    url: TARGET_URL,
    render_js: true,
    js_scenario: JSON.stringify(jsScenario)
  };

  try {
    console.log('Sending request to ScrapingBee with params:', params);
    const response = await axios.get('https://app.scrapingbee.com/api/v1/', { params, timeout: 10000 });
    console.log('Response received, checking for ads...');
    const result = {
      statusCode: 200,
      body: JSON.stringify({
        message: response.data.includes('ad-') || response.data.includes('advert')
          ? 'Ad loaded successfully'
          : 'Ad not loaded',
        dataSnippet: response.data.substring(0, 200)
      })
    };
    return result;
  } catch (error) {
    console.error('Error details:', error.message, error.response ? error.response.status : 'No status');
    return {
      statusCode: 500,
      body: JSON.stringify({
        error: `Request failed: ${error.message}`,
        status: error.response ? error.response.status : 'Unknown'
      })
    };
  }
};
