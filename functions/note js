const axios = require('axios');

exports.handler = async function(event, context) {
  // استخدام متغير بيئي لمفتاح API (يجب إضافته في إعدادات Netlify)
  const API_KEY = process.env.API_KEY || 'YOUR_API_KEY'; // النسخة الاحتياطية إذا لم يكن المتغير موجودًا
  const TARGET_URL = 'https://btc240.netlify.app/';
  const waitTime = Math.floor(Math.random() * 21) + 20;

  const jsScenario = {
    instructions: [
      { wait: 10 },
      { wait: waitTime },
      { scroll_y: 500 },
      { scroll_y: 1000 },
      { wait: 5 }
    ]
  };

  const params = {
    api_key: API_KEY,
    url: TARGET_URL,
    render_js: true,
    js_scenario: JSON.stringify(jsScenario)
  };

  try {
    const response = await axios.get('https://app.scrapingbee.com/api/v1/', { params, timeout: 150000 });
    const result = {
      statusCode: 200,
      body: JSON.stringify({
        message: response.data.includes('ad-') || response.data.includes('advert') 
          ? 'Ad loaded successfully' 
          : 'Ad not loaded',
        data: response.data.substring(0, 500) // إرجاع جزء من البيانات للتأكد
      })
    };
    return result;
  } catch (error) {
    console.error('Error in function:', error.message);
    return {
      statusCode: 500,
      body: JSON.stringify({
        error: `Failed to process request: ${error.message}`
      })
    };
  }
};
