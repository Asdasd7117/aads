const axios = require('axios');

exports.handler = async function(event, context) {
  const API_KEY = process.env.API_KEY;
  console.log('Function started, API_KEY:', API_KEY ? 'Found' : 'Not found');
  if (!API_KEY) {
    return {
      statusCode: 400,
      body: JSON.stringify({ error: 'API_KEY is missing' })
    };
  }

  const TARGET_URL = 'https://btc240.netlify.app/';
  const waitTime = Math.floor(Math.random() * 5) + 5; // تقليل وقت الانتظار للاختبار

  const jsScenario = {
    instructions: [
      { wait: 5 }, // تقليل الانتظار
      { scroll_y: 500 }
    ]
  };

  const params = {
    api_key: API_KEY,
    url: TARGET_URL,
    render_js: true,
    js_scenario: JSON.stringify(jsScenario)
  };

  try {
    console.log('Sending request to ScrapingBee with params:', JSON.stringify(params));
    const response = await axios.get('https://app.scrapingbee.com/api/v1/', { params, timeout: 5000 }); // تقليل المهلة
    console.log('Response received, status:', response.status);
    const result = {
      statusCode: 200,
      body: JSON.stringify({
        message: response.data.includes('ad-') || response.data.includes('advert')
          ? 'Ad loaded successfully'
          : 'Ad not loaded',
        dataSnippet: response.data.substring(0, 200)
      })
    };
    return result;
  } catch (error) {
    console.error('Error details:', error.message, error.response ? error.response.status : 'No status');
    return {
      statusCode: 500,
      body: JSON.stringify({
        error: `Request failed: ${error.message}`,
        status: error.response ? error.response.status : 'Unknown'
      })
    };
  }
};
